{% extends "base.html" %}

{% block title %}Appointment Status{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-10">
    <h1 class="text-3xl font-bold mb-5">Appointment Status</h1>
    <div class="bg-white shadow-md rounded px-8 pt-6 pb-8 mb-4">
        <p class="mb-4"><strong>Client Name:</strong> {{ appointment.client_name }}</p>
        <p class="mb-4"><strong>Address:</strong> {{ appointment.address }}</p>
        <p class="mb-4"><strong>Date:</strong> {{ appointment.appointment_time.strftime('%B %d, %Y') }}</p>
        <p class="mb-4"><strong>Time:</strong> {{ appointment.appointment_time.strftime('%I:%M %p') }}</p>
        <p class="mb-4"><strong>Status:</strong> <span id="appointment-status">{{ appointment.status }}</span></p>
    </div>
    <div id="map" class="map-container mb-4"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script>
    const socket = io();
    const appointmentId = {{ appointment.id }};
    const appointmentStatus = document.getElementById('appointment-status');
    const map = L.map('map').setView([{{ appointment.latitude }}, {{ appointment.longitude }}], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const appointmentMarker = L.marker([{{ appointment.latitude }}, {{ appointment.longitude }}]).addTo(map);
    let barberMarker;

    // Listen for appointment status updates
    socket.on('appointment_status_updated', (data) => {
        if (data.appointment_id == appointmentId) {
            appointmentStatus.textContent = data.status;
        }
    });

    // Listen for barber location updates
    socket.on('barber_location_updated', (data) => {
        if (barberMarker) {
            map.removeLayer(barberMarker);
        }
        barberMarker = L.marker([data.latitude, data.longitude], {icon: L.icon({iconUrl: '{{ url_for("static", filename="images/barber-icon.png") }}', iconSize: [32, 32]})}).addTo(map);
        map.fitBounds(L.latLngBounds([appointmentMarker.getLatLng(), barberMarker.getLatLng()]));
    });
</script>
{% endblock %}
